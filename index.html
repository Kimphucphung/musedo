<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Muse.do | Productivity Work Measurement Tool</title>
  <!-- Tailwind via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            roseglass: { 50:'#fff1f5',100:'#ffe4ec',200:'#fecdd6',300:'#fda4b8',400:'#fb7185',500:'#f43f5e' }
          },
          boxShadow: { glass: '0 10px 40px -10px rgba(240,46,170,.25)' }
        }
      }
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .blob{filter:blur(60px);opacity:.7}
    /* Garden visuals */
    .garden-water {background: radial-gradient(120% 120% at 50% 0%, #fdf2f8 0%, #ffe4e6 35%, #fbcfe8 70%, #f5d0fe 100%);} 
    .island {position:relative;width:90%;max-width:760px;margin: auto; height:380px;border-radius:50% 50% 45% 55% / 60% 40% 60% 40%;background: radial-gradient(60% 60% at 50% 40%, #bbf7d0 0%, #86efac 45%, #22c55e 60%, #16a34a 75%, #0ea5e9 120%);box-shadow: inset 0 8px 30px rgba(0,0,0,.15), 0 15px 40px rgba(0,0,0,.25);}    .flower {position:absolute; transform-origin: bottom center;} 
    .flower svg {filter: drop-shadow(0 6px 10px rgba(0,0,0,.1));}
    .flower.sm {transform: translate(-50%, -100%) scale(.8)  rotate(var(--rot,0deg));}
    .flower.md {transform: translate(-50%, -100%) scale(1)    rotate(var(--rot,0deg));}
    .flower.lg {transform: translate(-50%, -100%) scale(1.35) rotate(var(--rot,0deg));}
  </style>
</head>
<body class="min-h-screen text-rose-900 relative overflow-x-hidden">
  <!-- dreamy backdrop -->
  <div class="absolute inset-0 -z-10 bg-gradient-to-b from-pink-100 via-rose-100 to-fuchsia-100"></div>
  <div class="blob fixed -top-24 -left-28 h-80 w-80 rounded-full bg-pink-200"></div>
  <div class="blob fixed top-40 -right-20 h-96 w-96 rounded-full bg-fuchsia-200"></div>
  <div class="blob fixed bottom-10 left-1/2 h-72 w-72 -translate-x-1/2 rounded-full bg-rose-200"></div>

  <!-- NAV BAR -->
<nav class="sticky top-0 z-50 bg-white/50 backdrop-blur-xl border-b border-white/40 shadow-glass">
  <div class="relative mx-auto max-w-6xl px-4 sm:px-6 py-3 md:py-4 min-h-[56px] md:min-h-[64px] flex items-center md:justify-between">
    <!-- BRAND: mobile ·ªü gi·ªØa (absolute), desktop b√™n tr√°i (static) -->
    <div class="absolute left-1/2 -translate-x-1/2 md:static md:left-auto md:translate-x-0">
      <div class="text-2xl md:text-3xl font-black tracking-tight select-none text-center md:text-left">muse.do
      </div>
    </div>
    <!-- HAMBURGER: ch·ªâ mobile, ƒë·∫∑t absolute b√™n ph·∫£i -->
    <button id="menuBtn"
      class="md:hidden absolute right-4 top-1/2 -translate-y-1/2
             inline-flex items-center justify-center h-9 w-9 rounded-full hover:bg-white/70"
      aria-label="Open menu">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="3" y1="6"  x2="21" y2="6"/>
        <line x1="3" y1="12" x2="21" y2="12"/>
        <line x1="3" y1="18" x2="21" y2="18"/>
      </svg>
    </button>
    <!-- Tabs + Auth (ch·ªâ desktop, n·∫±m b√™n ph·∫£i) -->
    <div class="order-3 hidden md:flex items-center gap-4 ml-auto">
      <button class="navBtn px-3 py-1 rounded-full font-semibold hover:bg-white/70
                     data-[active=true]:bg-rose-400 data-[active=true]:text-white"
              data-tab="tasks">Tasks</button>
      <button class="navBtn px-3 py-1 rounded-full font-semibold hover:bg-white/70
                     data-[active=true]:bg-rose-400 data-[active=true]:text-white"
              data-tab="garden">Garden</button>
      <button class="navBtn px-3 py-1 rounded-full font-semibold hover:bg-white/70
                     data-[active=true]:bg-rose-400 data-[active=true]:text-white"
              data-tab="timer">Timer</button>
      <button class="navBtn px-3 py-1 rounded-full font-semibold hover:bg-white/70
                     data-[active=true]:bg-rose-400 data-[active=true]:text-white"
              data-tab="quotes">Quotes</button>
      <!-- Donate -->
      <a href="https://www.buymeacoffee.com/your_id" target="_blank" rel="noopener"
         class="px-3 py-1 rounded-full bg-rose-100 hover:bg-rose-200 text-rose-900 font-semibold">
        ‚ù§Ô∏è Donate
      </a>
      <!-- Auth (desktop) -->
      <div id="authBox" class="text-sm flex items-center gap-2">
        <span id="authStatus" class="opacity-70">Not signed in</span>
        <button id="btnGoogle" class="px-3 py-1 rounded-full bg-white/70 hover:bg-white">
          Sign in with Google
        </button>
        <button id="btnSignOut" class="hidden px-3 py-1 rounded-full bg-white/70 hover:bg-white">
          Sign out
        </button>
      </div>
    </div>
  </div>
</nav>

<!-- MOBILE SIDE DRAWER (NEW) -->
<div id="mobileSheet" class="fixed inset-0 z-50 hidden">
  <!-- overlay -->
  <div id="sheetOverlay" class="absolute inset-0 bg-black/20 backdrop-blur-[2px]"></div>
  <!-- panel -->
  <div id="sheetPanel"
       class="absolute right-0 top-0 h-full w-64 max-w-[80%] bg-white/90 backdrop-blur-xl border-l border-white/60 shadow-xl
              translate-x-full transition-transform duration-300">
    <div class="p-4 border-b border-white/60 flex items-center justify-between">
      <div class="font-bold">Menu</div>
      <button id="sheetClose" class="h-8 w-8 rounded-full hover:bg-white/70" aria-label="Close">‚úï</button>
    </div>
    <!-- Subtitle pill ch·ªâ hi·ªán tr√™n mobile -->
    <div class="px-4 py-3 md:hidden">
      <span
        class="inline-flex items-center rounded-full bg-rose-200/60
        px-3 py-1 text-xs font-semibold text-rose-800 border border-white/50">Tin Work Measurement
      </span>
    </div>
    <div class="p-3 flex flex-col gap-2">
      <button class="mobileTabBtn text-left px-3 py-2 rounded-xl hover:bg-white" data-tab="tasks">Tasks</button>
      <button class="mobileTabBtn text-left px-3 py-2 rounded-xl hover:bg-white" data-tab="garden">Garden</button>
      <button class="mobileTabBtn text-left px-3 py-2 rounded-xl hover:bg-white" data-tab="timer">Timer</button>
      <button class="mobileTabBtn text-left px-3 py-2 rounded-xl hover:bg-white" data-tab="quotes">Quotes</button>
    </div>
      <!-- Auth trong drawer (ch·ªâ mobile) -->
    <div class="mt-2 p-3 border-t border-white/60 md:hidden">
        <div class="text-xs opacity-70 mb-2" id="authStatusM">Not signed in</div>
        <div class="flex gap-2">
          <button id="btnGoogleM" class="px-3 py-1 rounded-full bg-white/70 hover:bg-white">Sign in with Google</button>
          <button id="btnSignOutM" class="hidden px-3 py-1 rounded-full bg-white/70 hover:bg-white">Sign out</button>
        </div>
        <a href="https://www.buymeacoffee.com/your_id" target="_blank" class="mt-2 inline-block px-3 py-2 rounded-full bg-rose-100 text-rose-900 font-semibold">‚ù§Ô∏è Donate</a>
    </div>
  </div>
</div>

  <main>
    <!-- ============ TAB: TASKS ============ -->
<section id="tab-tasks">
  <header class="px-6 pt-8 pb-4">
    <div class="mx-auto flex max-w-6xl items-center justify-between">
      <!-- LEFT: brand + subtitle -->
      <h1 class="flex items-center gap-3">
        <!-- logo text -->
        <span class="select-none leading-none 
                     text-4xl md:text-5xl font-black tracking-tight">
          <span class="text-rose-900">muse.</span>
          <span class="text-roseglass-500">do</span>
        </span>
        <!-- subtitle pill -->
        <span
           class="hidden md:inline-flex inline-flex items-center rounded-full bg-rose-200/60 px-3 py-1 text-xs font-semibold text-rose-800 border border-white/50">Tin Work Measurement
        </span>
      </h1>
      <!-- RIGHT: Today button -->
      <div class="flex items-center gap-2">
        <button id="todayBtn"
          class="rounded-full px-3 py-2 backdrop-blur-xl bg-white/50
                 border border-white/40 shadow-glass hover:bg-white/60 transition">
          Today
        </button>

        <button id="reportBtn"
          class="rounded-full px-3 py-2 backdrop-blur-xl bg-white/60
                 border border-white/40 shadow-glass hover:bg-white/80 transition">
          Report
        </button>
      </div>
    </div>
  </header>

      <section class="mx-auto grid max-w-6xl grid-cols-1 gap-6 px-6 pb-16 md:grid-cols-[300px_1fr] lg:grid-cols-[300px_minmax(400px,1fr)_360px]">
        <!-- Calendar -->
        <aside class="rounded-3xl p-4 md:p-5 backdrop-blur-xl bg-white/50 border border-white/40 shadow-glass">
          <div class="mb-3 flex items-center justify-between">
            <button id="prevMonth" class="rounded-full p-2 hover:bg-white/70">
              <div class="flex items-center justify-center"><img src="Asset/left-arrow.png" alt="" class="h-4 object-contain rounded-xl "></div>
            </button>
            <div id="monthLabel" class="font-semibold flex items-center gap-2">üìÖ</div>
            <button id="nextMonth" class="rounded-full p-2 hover:bg-white/70">
              <div class="flex items-center justify-center"><img src="Asset/right-arrow.png" alt="" class="h-4 object-contain rounded-xl "></div>
            </button>
          </div>
          <div class="grid grid-cols-7 text-center text-xs font-medium text-rose-600/80">
            <div>SUN</div><div>MON</div><div>TUE</div><div>WED</div><div>THU</div><div>FRI</div><div>SAT</div>
          </div>
          <div id="calendarGrid" class="grid grid-cols-7 gap-2"></div>
          <div class="mt-4 rounded-2xl p-3 bg-white/60">
            <div class="flex items-center justify-between text-sm"><span>Month completion</span><span id="monthCompletion" class="font-semibold">0%</span></div>
            <div class="mt-2 h-2 w-full overflow-hidden rounded-full bg-rose-100"><div id="monthBar" class="h-2 rounded-full bg-roseglass-400" style="width:0%"></div></div>
            <div class="mt-2 grid grid-cols-3 text-center text-xs"><div><div id="doneCount" class="font-semibold">0</div><div>done</div></div><div><div id="totalCount" class="font-semibold">0</div><div>tasks</div></div><div><div id="streakCount" class="font-semibold">0üî•</div><div>streak</div></div></div>
          </div>
        </aside>

        <!-- Note Track Center -->
        <section class="relative overflow-hidden rounded-3xl p-4 md:p-6 backdrop-blur-xl bg-white/50 border border-white/40 shadow-glass">
          <div class="absolute -right-20 -top-20 h-40 w-40 rounded-full bg-rose-200/70 blur-3xl"></div>
          <div class="mb-4 flex items-center justify-between">
            <div>
              <div class="text-xs uppercase tracking-wide text-rose-700/70">DAY</div>
              <h2 id="dayLabel" class="text-2xl font-extrabold tracking-tight"></h2>
            </div>
            <div class="text-right">
              <div class="text-xs text-rose-700/70">Completion</div>
              <div id="dayCompletion" class="text-xl font-black">0%</div>
              <div class="text-[10px] inline-flex items-center gap-1 rounded-full bg-rose-100 px-2 py-1 mt-1">‚ú® vibe: <span id="vibe" class="font-semibold">Seed</span></div>
            </div>
          </div>

          <div class="mb-4 grid grid-cols-1 gap-2 md:grid-cols-[1fr_auto]">
            <div class="flex items-center gap-2 rounded-2xl bg-white/70 px-3 py-2 ring-1 ring-white/60 focus-within:ring-roseglass-400">
              <input id="newTitle" placeholder="Add a task that Future‚ÄëYou will thank Past‚ÄëYou for ‚ú®" class="w-full bg-transparent outline-none placeholder:text-rose-400"/>
              <select id="newPrio" class="rounded-full bg-rose-100 px-2 py-1 text-xs"><option value="1">chill</option><option value="2" selected>normal</option><option value="3">spicy</option></select>
            </div>
            <button id="addBtn" class="inline-flex items-center justify-center gap-2 rounded-2xl bg-roseglass-400 px-4 py-2 font-semibold text-white shadow-lg hover:brightness-105 active:translate-y-px">Ôºã Add</button>
            <textarea id="newNote" placeholder="optional notes‚Ä¶" class="md:col-span-2 h-20 rounded-2xl bg-white/60 p-3 text-sm outline-none ring-1 ring-white/50 focus:ring-roseglass-400"></textarea>
          </div>

          <ul id="taskList" class="space-y-2"></ul>
          <div id="emptyMsg" class="hidden rounded-2xl bg-white/60 p-6 text-center text-sm">No tasks for this day yet. Drop one above and let it bloom üå∏</div>
        </section>

        <!-- Statistic -->
        <aside class="block rounded-3xl p-4 backdrop-blur-xl bg-white/50 border border-white/40 shadow-glass">
          <div class="mb-3 flex items-center justify-between"><h3 class="text-lg font-bold">Stats & Patterns</h3><div id="statsMonth" class="text-xs text-rose-700/70"></div></div>
          <div class="h-40 w-full rounded-2xl bg-white/70 p-2"><canvas id="barChart" height="140"></canvas></div>
          <div class="mt-3 grid grid-cols-2 gap-3">
            <div class="rounded-2xl bg-white/70 p-2"><canvas id="pieChart" height="160"></canvas><div class="text-center text-xs"><span id="miniDone">0</span>/<span id="miniTotal">0</span> done</div></div>
            <div class="rounded-2xl bg-white/70 p-4"><div class="text-xs text-rose-700/70">Streak</div><div id="streakText" class="text-3xl font-black">0 days</div><div class="mt-2 text-xs">Keep one tiny win per day. Your future self is applauding üéÄ</div></div>
          </div>
          <div class="mt-3 rounded-2xl bg-white/70 p-4"><div class="flex items-center gap-2 text-sm font-semibold">‚ú® Mini milestones</div>
            <ul class="mt-2 list-disc pl-5 text-sm"><li id="mm60">Reach 60% today</li><li id="mm100">Perfect day (100%)</li><li id="mm50m">50%+ this month</li></ul>
          </div>
        </aside>
      </section>
    </section>

    <!-- ============ TAB: GARDEN ============ -->
    <section id="tab-garden" class="hidden px-6 py-8">
      <div class="mx-auto max-w-5xl rounded-3xl p-6 backdrop-blur-xl bg-white/50 border border-white/40 shadow-glass">
        <div class="flex items-center justify-between"><h2 class="text-2xl font-bold">Achievement Garden üå±</h2><div class="text-xs text-rose-700/70" id="gardenMonth"></div></div>
        <div class="garden-water mt-4 rounded-3xl p-4"><div class="island mx-auto relative" id="gardenCanvas"></div></div>
        <div class="mt-4 grid grid-cols-1 sm:grid-cols-3 gap-3 text-sm">
          <div class="rounded-2xl bg-white/70 p-3"><div class="font-semibold">Rules</div><div>Complete <b>every day tasks</b> will plant <b>a flower</b>.</div><div>2‚Äì4 task ‚Üí <b>small</b> flower, 5‚Äì6 ‚Üí <b>medium</b>, ‚â•7 ‚Üí <b>big</b>.</div></div>
          <div class="rounded-2xl bg-white/70 p-3"><div class="font-semibold">Today</div><div id="gardenToday"></div></div>
          <div class="rounded-2xl bg-white/70 p-3"><div class="font-semibold">Tip</div><div>Come back and complete daily tasks to see the flowers bloom üå∏</div></div>
        </div>
      </div>
    </section>

    <!-- ============ TAB: TIMER ============ -->
    <section id="tab-timer" class="hidden px-6 py-8">
      <div class="mx-auto max-w-xl rounded-3xl p-6 text-center backdrop-blur-xl bg-white/50 border border-white/40 shadow-glass">
        <h2 class="text-2xl font-bold mb-2">Focus Timer ‚è≥</h2>
        <div class="text-sm text-rose-700/70 mb-4">Select working time, press Start. When time is up, it will ring + remind you to take a break.</div>
        <div class="flex items-center justify-center gap-2 mb-4">
          <input id="tMin" type="number" min="0" value="25" class="w-20 rounded-xl bg-white/80 p-2 text-center ring-1 ring-white/60" />
          <span>:</span>
          <input id="tSec" type="number" min="0" max="59" value="00" class="w-20 rounded-xl bg-white/80 p-2 text-center ring-1 ring-white/60" />
        </div>
        <div class="flex flex-wrap items-center justify-center gap-2 mb-4">
          <button class="px-3 py-1 rounded-full bg-rose-100" data-preset="25">Pomodoro 25</button>
          <button class="px-3 py-1 rounded-full bg-rose-100" data-preset="5">Break 5</button>
          <button class="px-3 py-1 rounded-full bg-rose-100" data-preset="15">Break 15</button>
        </div>
        <div class="text-5xl font-black tracking-wider mb-4" id="tDisplay">25:00</div>
        <div class="flex items-center justify-center gap-3">
          <button id="tStart" class="px-4 py-2 rounded-full bg-rose-400 text-white shadow">Start</button>
          <button id="tPause" class="px-4 py-2 rounded-full bg-white/90 shadow ring-1 ring-white/60">Pause</button>
          <button id="tReset" class="px-4 py-2 rounded-full bg-white/90 shadow ring-1 ring-white/60">Reset</button>
        </div>
        <div id="restBanner" class="hidden mt-6 rounded-2xl bg-white/80 p-4 ring-1 ring-white/60">
          <div class="text-xl font-bold mb-2">Don't Overwork Yourself üíó</div>
          <div class="mb-3">Give Yourself <b>15 Minutes</b> Rest, Honey.</div>
          <div class="flex items-center justify-center">
            <img src="Asset/cat-meme.png" alt="cat-meme" class="h-32 object-contain rounded-xl shadow" />
          </div>
        </div>
      </div>
    </section>

    <!-- ============ TAB: QUOTES ============ -->
    <section id="tab-quotes" class="hidden px-6 py-8">
      <div class="mx-auto max-w-xl rounded-3xl p-6 text-center backdrop-blur-xl bg-white/50 border border-white/40 shadow-glass">
        <h2 class="text-2xl font-bold mb-4">Weird Inspiration ‚ú®</h2>
        <blockquote id="quoteBox" class="italic">Click button to get a quote!</blockquote>
        <button id="newQuoteBtn" class="mt-4 px-4 py-2 rounded-full bg-rose-400 text-white">New Quote</button>
      </div>
    </section>

      <!-- Weekly/Monthly Report Modal -->
  <div id="reportModal" class="fixed inset-0 z-[60] hidden">
    <!-- overlay -->
    <div id="reportOverlay" class="absolute inset-0 bg-black/30 backdrop-blur-sm"></div>
    <!-- panel -->
    <div class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2
                w-[92vw] max-w-3xl rounded-3xl bg-white/90 backdrop-blur-xl
                border border-white/60 shadow-2xl p-5">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-xl font-bold">Weekly & Monthly Report</h3>
        <div class="flex items-center gap-2">
          <button id="exportCSVBtn"
            class="px-3 py-1 rounded-full bg-rose-100 hover:bg-rose-200 text-rose-900 font-semibold">
            Export CSV
          </button>
          <button id="reportClose" class="h-8 w-8 rounded-full hover:bg-white/70">‚úï</button>
         </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <!-- WEEK -->
        <div class="rounded-2xl bg-white/70 p-4 ring-1 ring-white/60">
          <div class="text-sm text-rose-700/70 mb-1" id="weekLabel">This week</div>
          <div class="text-3xl font-black mb-2"><span id="weekPct">0</span>%</div>
          <div class="text-xs mb-2">
            <b><span id="weekDone">0</span>/<span id="weekTotal">0</span></b> tasks completed
          </div>
          <canvas id="weekChart" height="140"></canvas>
        </div>

        <!-- MONTH -->
        <div class="rounded-2xl bg-white/70 p-4 ring-1 ring-white/60">
          <div class="text-sm text-rose-700/70 mb-1" id="monthLabelRpt">This month</div>
          <div class="text-3xl font-black mb-2"><span id="monthPctRpt">0</span>%</div>
          <div class="text-xs mb-2">
            <b><span id="monthDoneRpt">0</span>/<span id="monthTotalRpt">0</span></b> tasks completed
          </div>
          <canvas id="monthChartRpt" height="140"></canvas>
        </div>
      </div>

      <div class="mt-4 text-xs text-rose-700/70">
        *Report d·ª±a tr√™n d·ªØ li·ªáu task hi·ªán c√≥ trong local/cloud.
      </div>
    </div>
  </div>
  </main>

  <footer class="mx-auto max-w-6xl px-6 pb-10 text-center text-xs text-rose-700/70">Pro‚Äëtip: tiny tasks, tiny wins. Weirdly satisfying.</footer>

<script>
// ===== Utilities =====
function toLocalISO(date) {
  const d = new Date(date);
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,'0');
  const day = String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${day}`;
}
const $ = (s)=>document.querySelector(s); const $$=(s)=>Array.from(document.querySelectorAll(s));
const tabs=['tasks','garden','timer','quotes'];
function showTab(name){
  tabs.forEach(t=>{const el=$('#tab-'+t); if(!el) return; (t===name)?el.classList.remove('hidden'):el.classList.add('hidden');});
  $$('.navBtn').forEach(b=> b.dataset.active = (b.dataset.tab===name));
  if(name==='tasks') render();
  if(name==='garden') updateGarden();
  if(name==='timer') syncInputsFromRemaining();
}
$$('.navBtn').forEach(btn=> btn.addEventListener('click',()=> showTab(btn.dataset.tab)));

// ========== Mobile hamburger sheet ==========
const menuBtn     = $('#menuBtn');
const mobileSheet = $('#mobileSheet');
const sheetPanel  = $('#sheetPanel');
const sheetOverlay= $('#sheetOverlay');
const sheetClose  = $('#sheetClose');

function openSheet(){
  // hi·ªán l·ªõp ph·ªß
  mobileSheet.classList.remove('hidden');
  // ch·ªù 1 frame ƒë·ªÉ CSS transition ho·∫°t ƒë·ªông
  requestAnimationFrame(()=> sheetPanel.classList.remove('translate-x-full'));
}
function closeSheet(){
  // ƒë·∫©y panel ra ngo√†i tr∆∞·ªõc
  sheetPanel.classList.add('translate-x-full');
  // khi transition xong m·ªõi ·∫©n h·∫≥n overlay
  sheetPanel.addEventListener('transitionend', ()=> {
    mobileSheet.classList.add('hidden');
  }, { once:true });
}

menuBtn?.addEventListener('click', openSheet);
sheetOverlay?.addEventListener('click', closeSheet);
sheetClose?.addEventListener('click', closeSheet);
// b·∫•m v√†o c√°c item trong sheet th√¨ chuy·ªÉn tab + ƒë√≥ng sheet
$$('.mobileTabBtn').forEach(b => b.addEventListener('click', () => {
  showTab(b.dataset.tab);
  closeSheet();
}));

// ===== Core state for Tasks =====
const STORAGE_KEY='weird-productivity-nobuild-v3';
const todayISO=()=> toLocalISO(new Date());
function startOfMonth(d){d=new Date(d);return new Date(d.getFullYear(),d.getMonth(),1)}
function endOfMonth(d){d=new Date(d);return new Date(d.getFullYear(),d.getMonth()+1,0)}
function addDays(date,days){const d=new Date(date);d.setDate(d.getDate()+days);return d}
function fmtMonth(d){return new Intl.DateTimeFormat(undefined,{month:'long',year:'numeric'}).format(new Date(d))}
function fmtDayLong(d){return new Intl.DateTimeFormat(undefined,{weekday:'long',month:'long',day:'numeric'}).format(new Date(d))}
function id(){return Math.random().toString(36).slice(2,9)}
function prioLabel(p){return p==3?'spicy':p==2?'normal':'chill'}
let state=loadState(); let selectedDate=todayISO(); let bar,pie;
function loadState(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if (raw) return JSON.parse(raw);
  }catch(e){}
  return { tasks: demoTasks() };
}
async function saveState(){
  try{
    // g·∫Øn m·ªëc th·ªùi gian local ƒë·ªÉ so s√°nh v·ªõi Cloud
    state.updatedAt = Date.now();
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  }catch(e){}
  const uid = window.__MUSE_UID__;
  if (!uid) return; // ch∆∞a ƒëƒÉng nh·∫≠p th√¨ t·∫°m l∆∞u local, ƒëƒÉng nh·∫≠p xong s·∫Ω sync
  window.dispatchEvent(new CustomEvent("muse:requestSave", { detail: state }));
}
function demoTasks(){const t=new Date();t.setHours(0,0,0,0);const iso=(d)=>{ d.setHours(0,0,0,0); return toLocalISO(d); };const y1=new Date(t);y1.setDate(t.getDate()-1);const y2=new Date(t);y2.setDate(t.getDate()-2);return[
  
{id:id(),title:'Morning stretch & water',date:iso(y2),done:true,priority:1},
{id:id(),title:'Write 3 lines of journal',date:iso(y2),done:true,priority:2},
{id:id(),title:'Read 10 pages',date:iso(y1),done:true,priority:2},
{id:id(),title:'Email follow-ups (Greental)',date:iso(y1),done:false,priority:3},
{id:id(),title:'HEXACO intro draft',date:iso(t),done:false,priority:3},
{id:id(),title:'Placement logbook review',date:iso(t),done:false,priority:2},
{id:id(),title:'Walk 15 minutes',date:iso(t),done:false,priority:1},]}
function tasksFor(date){return state.tasks.filter(t=>t.date===date)}
function groupByDate(tasks){const m=new Map();tasks.forEach(t=>{if(!m.has(t.date))m.set(t.date,[]);m.get(t.date).push(t)});return m}
function computeMonthStats(monthDate){const start=startOfMonth(monthDate),end=endOfMonth(monthDate);const arr=state.tasks.filter(t=>new Date(t.date)>=start&&new Date(t.date)<=end);const map=groupByDate(arr);let total=0,done=0;const daily=[];for(let d=new Date(start);d<=end;d=addDays(d,1)){const iso=toLocalISO(d);const list=map.get(iso)||[];const dt=list.length;const dd=list.filter(x=>x.done).length;total+=dt;done+=dd;daily.push({iso,total:dt,done:dd})}const completion=total?Math.round(done/total*100):0;return{total,done,completion,daily}}
function computeStreak(){const map=groupByDate(state.tasks);let streak=0;let d=new Date();d.setHours(0,0,0,0);while(true){const iso=toLocalISO(d);const list=map.get(iso)||[];if(list.some(t=>t.done)){streak++;d=addDays(d,-1)}else break}return streak}
function render(){
  $('#monthLabel').textContent=fmtMonth(selectedDate); $('#statsMonth').textContent=fmtMonth(selectedDate); $('#dayLabel').textContent=fmtDayLong(selectedDate);
  const start=startOfMonth(selectedDate), end=endOfMonth(selectedDate); const first=start.getDay(); const wrap=$('#calendarGrid'); wrap.innerHTML=''; for(let i=0;i<first;i++){const s=document.createElement('div'); s.className='opacity-50'; wrap.appendChild(s)}
  const stats=computeMonthStats(selectedDate); stats.daily.forEach((d)=>{const btn=document.createElement('button');btn.className='relative aspect-square rounded-2xl p-2 text-left transition hover:bg-white/60 '+(d.iso===selectedDate?'bg-white/80 ring-2 ring-roseglass-300':'');btn.innerHTML=`<div class="flex h-full flex-col justify-between"><div class="flex items-center justify-between"><span class="text-sm font-semibold">${new Date(d.iso).getDate().toString().padStart(2,'0')}</span>${d.total>0?`<span class=\"block h-6 w-6 rounded-full border-2 border-pink-200 relative\"><span class=\"absolute inset-0 rounded-full\" style=\"box-shadow: inset 0 0 0 9999px rgba(251,113,133,${(d.done/d.total).toFixed(2)})\"></span></span>`:''}</div><div class="text-[10px] text-rose-700/70">${d.total>0?Math.round(d.done/d.total*100)+'%':''}</div></div>`;btn.addEventListener('click',()=>{selectedDate=d.iso;render()});wrap.appendChild(btn)});
  $('#monthCompletion').textContent=stats.completion+'%'; $('#monthBar').style.width=stats.completion+'%'; $('#doneCount').textContent=stats.done; $('#totalCount').textContent=stats.total; const streak=computeStreak(); $('#streakCount').textContent=streak+'üî•'; $('#streakText').textContent=streak+' days'; $('#miniDone').textContent=stats.done; $('#miniTotal').textContent=stats.total;
  const list=tasksFor(selectedDate); const ul=$('#taskList'); ul.innerHTML=''; if(list.length===0)$('#emptyMsg').classList.remove('hidden'); else $('#emptyMsg').classList.add('hidden'); list.forEach(t=>{const li=document.createElement('li'); li.className='group rounded-2xl bg-white/70 p-3 ring-1 ring-white/60 hover:ring-roseglass-300'; li.innerHTML=`<div class=\"flex items-start gap-3\"><button class=\"mt-1 inline-flex h-6 w-6 items-center justify-center rounded-full border ${t.done?'bg-roseglass-400 text-white border-roseglass-400':'border-roseglass-300 bg-white'}\">${t.done?'‚úì':''}</button><div class=\"flex-1\"><div contenteditable=\"true\" class=\"taskTitle text-sm md:text-base ${t.done?'line-through opacity-60':''}\">${t.title}</div>${t.notes?`<div class=\"mt-1 text-xs text-rose-700/80\">${t.notes}</div>`:''}<div class=\"mt-2 inline-flex items-center gap-2 text-[10px]\"><span class=\"rounded-full px-2 py-0.5 ${t.priority==3?'bg-rose-200 text-rose-900':t.priority==2?'bg-pink-100 text-pink-900':'bg-fuchsia-100 text-fuchsia-900'}\">priority: ${prioLabel(t.priority)}</span>${t.done?'<span class=\"rounded-full bg-emerald-100 px-2 py-0.5 text-emerald-700\">completed</span>':''}</div></div><button class=\"opacity-0 transition group-hover:opacity-100 text-roseglass-500\">üóë</button></div>`; const [toggleBtn,titleDiv,delBtn]=[li.querySelector('button'),li.querySelector('.taskTitle'),li.querySelectorAll('button')[1]]; toggleBtn.addEventListener('click',()=>{t.done=!t.done;saveState();render()}); titleDiv.addEventListener('keydown',(e)=>{if(e.key==='Enter'){e.preventDefault();titleDiv.blur()}}); titleDiv.addEventListener('blur',()=>{t.title=titleDiv.textContent.trim()||t.title;saveState();render()}); delBtn.addEventListener('click',()=>{state.tasks=state.tasks.filter(x=>x.id!==t.id);saveState();render()}); ul.appendChild(li)});
  const done=list.filter(x=>x.done).length; const total=list.length; const pct=total?Math.round(done/total*100):0; $('#dayCompletion').textContent=pct+'%'; $('#vibe').textContent=pct===100?'Blossoming':(pct>=60?'Rosy':(pct>0?'Petal':'Seed'));
  const labels=stats.daily.map(d=>new Date(d.iso).getDate()); const totalArr=stats.daily.map(d=>d.total); const doneArr=stats.daily.map(d=>d.done); const barCtx=$('#barChart').getContext('2d'); if(bar) bar.destroy(); bar=new Chart(barCtx,{type:'bar',data:{labels,datasets:[{label:'Total',data:totalArr},{label:'Completed',data:doneArr}]},options:{responsive:true,plugins:{legend:{display:true}},scales:{y:{beginAtZero:true}}}}); const pieCtx=$('#pieChart').getContext('2d'); if(pie) pie.destroy(); pie=new Chart(pieCtx,{type:'pie',data:{labels:['Done','Remaining'],datasets:[{data:[stats.done,Math.max(stats.total-stats.done,0)]}]}});
  $('#mm60').className=(pct>=60?'line-through opacity-60':''); $('#mm100').className=(pct===100?'line-through opacity-60':''); $('#mm50m').className=(stats.completion>=50?'line-through opacity-60':'');
  if (!$('#tab-garden').classList.contains('hidden')) updateGarden();
}
$('#prevMonth').addEventListener('click',()=>{
  const d=new Date(selectedDate);
  d.setMonth(d.getMonth()-1);
  selectedDate=toLocalISO(
    new Date(d.getFullYear(), d.getMonth(),
      Math.min(new Date(selectedDate).getDate(), endOfMonth(d).getDate())
    )
  );   // ‚úÖ local ISO
  render();
});
$('#nextMonth').addEventListener('click',()=>{
  const d=new Date(selectedDate);
  d.setMonth(d.getMonth()+1);
  selectedDate=toLocalISO(
    new Date(d.getFullYear(), d.getMonth(),
      Math.min(new Date(selectedDate).getDate(), endOfMonth(d).getDate())
    )
  );   // ‚úÖ
  render();
});
$('#todayBtn').addEventListener('click',()=>{selectedDate=todayISO(); render()});
$('#addBtn').addEventListener('click', addTask);
$('#newTitle').addEventListener('keydown',(e)=>{if(e.key==='Enter'){e.preventDefault();addTask()}});
function addTask(){const titleInput=$('#newTitle').value.trim(); const noteInput=$('#newNote').value.trim(); const prio=parseInt($('#newPrio').value||'2'); const title=titleInput||(noteInput?noteInput.slice(0,60):''); if(!title) return; state.tasks.unshift({id:id(),title,date:selectedDate,done:false,priority:prio,notes:noteInput||undefined}); $('#newTitle').value=''; $('#newNote').value=''; $('#newPrio').value='2'; saveState(); render()}

// ===== Garden =====
function seedRng(seedStr){let h=2166136261>>>0; for(let i=0;i<seedStr.length;i++){h^=seedStr.charCodeAt(i); h=Math.imul(h,16777619);} return ()=>{h+=0x6D2B79F5; let t=Math.imul(h^(h>>>15),1|h); t^=t+Math.imul(t^(t>>>7),61|t); return((t^(t>>>14))>>>0)/4294967296};}
function flowerTier(doneCount){ if(doneCount>=7) return 'lg'; if(doneCount>=5) return 'md'; if(doneCount>=2) return 'sm'; return 'sm'; }
function flowerSVG(kind,c1,c2){ if(kind==='tulip')return`<svg width="80" height="120" viewBox="0 0 80 120" xmlns="http://www.w3.org/2000/svg"><rect x="38" y="55" width="4" height="55" rx="2" fill="#16a34a"/><path d="M10 80 C25 70, 30 70, 40 78" stroke="#16a34a" stroke-width="4" fill="none"/><path d="M70 80 C55 70, 50 70, 40 78" stroke="#16a34a" stroke-width="4" fill="none"/><path d="M40 55 C60 55, 66 40, 62 25 C54 35, 47 25, 40 18 C33 25, 26 35, 18 25 C14 40, 20 55, 40 55Z" fill="${c1}" stroke="${c2}" stroke-width="2"/></svg>`; if(kind==='peony')return`<svg width="96" height="126" viewBox="0 0 96 126" xmlns="http://www.w3.org/2000/svg"><rect x="46" y="60" width="4" height="60" rx="2" fill="#15803d"/><circle cx="48" cy="50" r="24" fill="${c1}"/><circle cx="40" cy="48" r="20" fill="${c1}"/><circle cx="56" cy="48" r="20" fill="${c1}"/><circle cx="48" cy="50" r="10" fill="${c2}"/></svg>`; return`<svg width="72" height="120" viewBox="0 0 72 120" xmlns="http://www.w3.org/2000/svg"><rect x="34" y="58" width="4" height="58" rx="2" fill="#16a34a"/><g transform="translate(36 46)"><circle r="8" fill="${c2}"/>${Array.from({length:12}).map((_,i)=>{const a=(i*30)*Math.PI/180; const x=Math.cos(a)*16, y=Math.sin(a)*16; return `<ellipse cx="${x}" cy="${y}" rx="7" ry="14" fill="${c1}" />`}).join('')}</g></svg>`; }
function createFlowerEl(kind,tier,leftPct,topPct,rotDeg){const wrap=document.createElement('div'); wrap.className=`flower ${tier}`; wrap.style.left=leftPct+'%'; wrap.style.top=topPct+'%'; wrap.style.setProperty('--rot',rotDeg+'deg'); const colors={daisy:['#fde68a','#f59e0b'], tulip:['#fb7185','#f43f5e'], peony:['#fda4af','#fecdd3']}; wrap.innerHTML=flowerSVG(kind,colors[kind][0],colors[kind][1]); return wrap;}
function updateGarden(){const canvas=$('#gardenCanvas'); if(!canvas) return; canvas.innerHTML=''; $('#gardenMonth').textContent=fmtMonth(selectedDate); const stats=computeMonthStats(selectedDate); const todayList=tasksFor(selectedDate); const td=todayList.filter(t=>t.done).length, tt=todayList.length; $('#gardenToday').textContent= tt? `${td}/${tt} completed (${Math.round(td/tt*100)}%)` : 'No tasks today'; stats.daily.forEach(d=>{ if(d.total>0 && d.done===d.total){ const rng=seedRng(d.iso); const tier=flowerTier(d.done); const kinds=['daisy','tulip','peony']; const kind=kinds[Math.floor(rng()*kinds.length)]; const left=20+rng()*60; const top=30+rng()*55; const rot=Math.floor(rng()*20-10); canvas.appendChild(createFlowerEl(kind,tier,left,top,rot)); } }); }

// ===== Timer =====
let tRemaining=25*60; let tId=null;
function formatTime(s){const m=Math.floor(s/60).toString().padStart(2,'0'); const sec=Math.floor(s%60).toString().padStart(2,'0'); return `${m}:${sec}`}
function syncInputsFromRemaining(){const m=Math.floor(tRemaining/60); const s=tRemaining%60; $('#tMin') && ($('#tMin').value=m); $('#tSec') && ($('#tSec').value=s.toString().padStart(2,'0')); $('#tDisplay') && ($('#tDisplay').textContent=formatTime(tRemaining));}
function readInputsToRemaining(){const m=parseInt($('#tMin').value||'0',10); const s=parseInt($('#tSec').value||'0',10); tRemaining=Math.max(0,m*60+Math.min(59,s)); $('#restBanner')?.classList.add('hidden'); $('#tDisplay').textContent=formatTime(tRemaining);}
function playBeep(){const ctx=new (window.AudioContext||window.webkitAudioContext)(); const o=ctx.createOscillator(); const g=ctx.createGain(); o.type='sine'; o.frequency.value=880; o.connect(g); g.connect(ctx.destination); g.gain.setValueAtTime(0.001,ctx.currentTime); g.gain.exponentialRampToValueAtTime(0.2,ctx.currentTime+0.02); o.start(); setTimeout(()=>{g.gain.exponentialRampToValueAtTime(0.0001,ctx.currentTime+0.25); o.stop(ctx.currentTime+0.3);},250);} 
function onTimerEnd(){ playBeep(); $('#restBanner')?.classList.remove('hidden'); }
function startTimer(){ if(tId) return; readInputsToRemaining(); if(tRemaining<=0) return; tId=setInterval(()=>{ tRemaining--; $('#tDisplay').textContent=formatTime(tRemaining); if(tRemaining<=0){ clearInterval(tId); tId=null; onTimerEnd(); } },1000);} 
function pauseTimer(){ if(tId){clearInterval(tId); tId=null;} }
function resetTimer(){ pauseTimer(); readInputsToRemaining(); $('#restBanner')?.classList.add('hidden'); }
$('#tMin')?.addEventListener('change',readInputsToRemaining); $('#tSec')?.addEventListener('change',readInputsToRemaining); $('#tStart')?.addEventListener('click',startTimer); $('#tPause')?.addEventListener('click',pauseTimer); $('#tReset')?.addEventListener('click',resetTimer); $$('#tab-timer [data-preset]').forEach(b=> b.addEventListener('click',()=>{ pauseTimer(); const minutes=parseInt(b.dataset.preset,10)||0; tRemaining=minutes*60; syncInputsFromRemaining(); $('#restBanner')?.classList.add('hidden'); })); syncInputsFromRemaining();

// ===== Quotes =====
const QUOTES=['Weird is wonderful üå∏','Tiny tasks, tiny wins.','Bloom where you are planted üå±','Your future self is applauding üëè','Its better to cry in a Lamborghini than cry in a Honda Civic', 'Whoever said money cant solve your problems? Must not have had enough money to solve them','Work smarter not harder, babe','Rich people not gonna marry dumb sh*t','If you‚Äôre lazy, someone dumber is taking your spot.','Cry now, flex later.','Excuses don‚Äôt pay bills.','You said tomorrow yesterday.','Complain less, conquer more.','Stay broke, or stay focused.','Grades don‚Äôt define you, but they decide if you eat instant noodles or steak.','Sleep is for the rich-grind is for the broke.','It‚Äôs better to be exhausted in a penthouse than relaxed in debt.','Ambition looks sexy, laziness doesn‚Äôt.','You studied 5 hours? Neighbor‚Äôs kid studied 10.','Rest when you‚Äôre rich, not when you‚Äôre tired.','Do you really want to be the failure in an Asian family?','Youre worth it! Always was, and alwaysa wil be'];
$('#newQuoteBtn')?.addEventListener('click',()=>{$('#quoteBox').textContent=QUOTES[Math.floor(Math.random()*QUOTES.length)]});

// ===== Init =====
showTab('tasks');

// ===== Report helpers =====
function startOfWeek(d = new Date()) {
  const t = new Date(d); t.setHours(0,0,0,0);
  const day = t.getDay(); // 0=Sun
  t.setDate(t.getDate() - day); // v·ªÅ Ch·ªß nh·∫≠t tu·∫ßn ƒë√≥
  return t;
}
function computeRangeStatsInclusive(start, end) {
  const s = new Date(start), e = new Date(end);
  s.setHours(0,0,0,0); e.setHours(0,0,0,0);
  const arr = state.tasks.filter(t => {
    const dt = new Date(t.date); dt.setHours(0,0,0,0);
    return dt >= s && dt <= e;
  });
  const map = groupByDate(arr);
  let total=0, done=0; const daily=[];
  for (let d=new Date(s); d<=e; d=addDays(d,1)) {
    const iso = toLocalISO(d);
    const list = map.get(iso) || [];
    const dt = list.length;
    const dd = list.filter(x=>x.done).length;
    total += dt; done += dd;
    daily.push({ iso, total: dt, done: dd });
  }
  const completion = total ? Math.round(done/total*100) : 0;
  return { total, done, completion, daily };
}

// open/close modal
let weekChartInst, monthChartInst;
function openReportModal() {
  // WEEK: t·ª´ Ch·ªß nh·∫≠t -> h√¥m nay
  const wStart = startOfWeek(new Date());
  const wEnd   = new Date(); wEnd.setHours(0,0,0,0);
  const wStats = computeRangeStatsInclusive(wStart, wEnd);

  // MONTH: d√πng computeMonthStats ƒë√£ c√≥
  const mStats = computeMonthStats(new Date());

  // Fill labels + numbers
  $('#weekPct').textContent      = wStats.completion;
  $('#weekDone').textContent     = wStats.done;
  $('#weekTotal').textContent    = wStats.total;
  $('#weekLabel').textContent    = `This week (${toLocalISO(wStart)} ‚Üí ${toLocalISO(wEnd)})`;

  $('#monthPctRpt').textContent   = mStats.completion;
  $('#monthDoneRpt').textContent  = mStats.done;
  $('#monthTotalRpt').textContent = mStats.total;
  $('#monthLabelRpt').textContent = `This month (${fmtMonth(new Date())})`;

  // Charts
  const wLabels = wStats.daily.map(d => new Date(d.iso).toLocaleDateString(undefined,{weekday:'short'}));
  const wDone   = wStats.daily.map(d => d.done);
  const wTotal  = wStats.daily.map(d => d.total);

  const mLabels = mStats.daily.map(d => new Date(d.iso).getDate());
  const mDone   = mStats.daily.map(d => d.done);
  const mTotal  = mStats.daily.map(d => d.total);

  if (weekChartInst) weekChartInst.destroy();
  if (monthChartInst) monthChartInst.destroy();

  weekChartInst = new Chart($('#weekChart').getContext('2d'), {
    type: 'bar',
    data: { labels: wLabels, datasets: [{ label:'Total', data:wTotal }, { label:'Completed', data:wDone }] },
    options: { responsive:true, scales:{ y:{ beginAtZero:true } } }
  });

  monthChartInst = new Chart($('#monthChartRpt').getContext('2d'), {
    type: 'bar',
    data: { labels: mLabels, datasets: [{ label:'Total', data:mTotal }, { label:'Completed', data:mDone }] },
    options: { responsive:true, scales:{ y:{ beginAtZero:true } } }
  });

  // show
  $('#reportModal').classList.remove('hidden');
}
function closeReportModal() {
  $('#reportModal').classList.add('hidden');
}

// ===== Export CSV (Weekly + Monthly) =====
function csvEsc(s){
  if (s == null) return '""';
  s = String(s).replace(/"/g,'""').replace(/\r?\n/g, ' ');
  return `"${s}"`;
}
function isBetweenISO(iso, startDate, endDate){
  const d = new Date(iso); d.setHours(0,0,0,0);
  const s = new Date(startDate); s.setHours(0,0,0,0);
  const e = new Date(endDate);   e.setHours(0,0,0,0);
  return d >= s && d <= e;
}
function exportCSVFromReport(){
  // Ranges
  const wStart = startOfWeek(new Date());
  const wEnd   = new Date(); wEnd.setHours(0,0,0,0);
  const mStart = startOfMonth(new Date());
  const mEnd   = endOfMonth(new Date());

  // Stats
  const wStats = computeRangeStatsInclusive(wStart, wEnd);
  const mStats = computeRangeStatsInclusive(mStart, mEnd);

  const lines = [];

  // Weekly summary
  lines.push('Weekly Summary');
  lines.push('Date,Total,Done,Completion%');
  wStats.daily.forEach(d=>{
    const pct = d.total ? Math.round(d.done/d.total*100) : 0;
    lines.push(`${d.iso},${d.total},${d.done},${pct}`);
  });
  lines.push('');

  // Monthly summary
  lines.push('Monthly Summary');
  lines.push('Date,Total,Done,Completion%');
  mStats.daily.forEach(d=>{
    const pct = d.total ? Math.round(d.done/d.total*100) : 0;
    lines.push(`${d.iso},${d.total},${d.done},${pct}`);
  });
  lines.push('');

  // Weekly tasks (raw)
  const weeklyTasks = state.tasks.filter(t => isBetweenISO(t.date, wStart, wEnd));
  lines.push('Weekly Tasks');
  lines.push('Date,Title,Done,Priority,Notes');
  weeklyTasks.forEach(t=>{
    lines.push([
      t.date,
      csvEsc(t.title),
      t.done ? 1 : 0,
      t.priority ?? '',
      csvEsc(t.notes || '')
    ].join(','));
  });
  lines.push('');

  // Monthly tasks (raw)
  const monthlyTasks = state.tasks.filter(t => isBetweenISO(t.date, mStart, mEnd));
  lines.push('Monthly Tasks');
  lines.push('Date,Title,Done,Priority,Notes');
  monthlyTasks.forEach(t=>{
    lines.push([
      t.date,
      csvEsc(t.title),
      t.done ? 1 : 0,
      t.priority ?? '',
      csvEsc(t.notes || '')
    ].join(','));
  });

  const blob = new Blob([lines.join('\n')], { type: 'text/csv;charset=utf-8;' });
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement('a');
  a.href = url;
  a.download = `muse-report-${toLocalISO(new Date())}.csv`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 1500);
}

// Bind export btn
$('#exportCSVBtn')?.addEventListener('click', exportCSVFromReport);

// bind buttons
$('#reportBtn')?.addEventListener('click', openReportModal);
$('#reportOverlay')?.addEventListener('click', closeReportModal);
$('#reportClose')?.addEventListener('click', closeReportModal);

</script>

<script type="module">
  // ---- Firebase SDKs ----
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import {
    getFirestore, doc, getDoc, setDoc, onSnapshot, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
  import {
    getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut
  } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCDYguh3q6kSKHMQIlx1_M6Kc2N28N7Sio",
    authDomain: "musedo-b6a21.firebaseapp.com",
    projectId: "musedo-b6a21",
    storageBucket: "musedo-b6a21.appspot.com",
    messagingSenderId: "840299933623",
    appId: "1:840299933623:web:c01ac0b487d37358d08232",
    measurementId: "G-1K2X7XQ9DQ"
  };

  // ---- Init ----
  const app  = initializeApp(firebaseConfig);
  const db   = getFirestore(app);
  const auth = getAuth(app);
  window.__MUSE_UID__ = null;

  // ---- Map UI elements cho desktop + mobile ----
  const statusEls     = [document.getElementById('authStatus'),  document.getElementById('authStatusM')].filter(Boolean);
  const btnGoogleEls  = [document.getElementById('btnGoogle'),   document.getElementById('btnGoogleM')].filter(Boolean);
  const btnSignOutEls = [document.getElementById('btnSignOut'),  document.getElementById('btnSignOutM')].filter(Boolean);

  function applyAuthUI({ signedIn, name }) {
    statusEls.forEach(el => el && (el.textContent = signedIn ? `Signed in (${name})` : 'Not signed in'));
    btnGoogleEls.forEach(el => el && el.classList.toggle('hidden', signedIn));
    btnSignOutEls.forEach(el => el && el.classList.toggle('hidden', !signedIn));
  }

  // Click: Google sign-in (c·∫£ 2 n∆°i)
  btnGoogleEls.forEach(btn => btn.addEventListener('click', async () => {
    try {
      const provider = new GoogleAuthProvider();
      await signInWithPopup(auth, provider);
    } catch (e) {
      alert('Google sign-in failed: ' + (e?.message || e));
      console.error(e);
    }
  }));

  // Click: Sign out (c·∫£ 2 n∆°i)
  btnSignOutEls.forEach(btn => btn.addEventListener('click', () => signOut(auth)));

  // ---- L·∫Øng nghe s·ª± ki·ªán save t·ª´ code Tasks v√† ghi Firestore ----
  window.addEventListener('muse:requestSave', async (e) => {
    const uid = window.__MUSE_UID__;
    if (!uid) return; // ch∆∞a ƒëƒÉng nh·∫≠p th√¨ b·ªè qua (ƒë√£ l∆∞u local trong saveState)
    try {
      const ref = doc(db, 'users', uid);
      const payload = { ...e.detail, updatedAt: serverTimestamp() };
      await setDoc(ref, payload, { merge: true });
    } catch (err) {
      console.error('setDoc failed', err);
      alert('Kh√¥ng l∆∞u ƒë∆∞·ª£c l√™n Cloud: ' + (err?.message || err));
    }
  });

  // ---- Khi tr·∫°ng th√°i ƒëƒÉng nh·∫≠p thay ƒë·ªïi ----
  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      window.__MUSE_UID__ = null;
      applyAuthUI({ signedIn: false });
      return;
    }

    // ƒêang ƒëƒÉng nh·∫≠p
    window.__MUSE_UID__ = user.uid;
    applyAuthUI({ signedIn: true, name: user.displayName || 'Google' });

    const ref = doc(db, 'users', user.uid);

    // L·∫•y cloud + local ƒë·ªÉ h√≤a gi·∫£i
    const snap = await getDoc(ref);
    const cloud = snap.exists() ? snap.data() : null;
    const localRaw = localStorage.getItem('weird-productivity-nobuild-v3');
    const local = localRaw ? JSON.parse(localRaw) : null;

    const cloudTime = cloud?.updatedAt?.toMillis?.() ?? 0; // Firestore Timestamp -> ms
    const localTime = local?.updatedAt ?? 0;               // ms do ta set ·ªü saveState()

    if (!cloud && local) {
      // Cloud ch∆∞a c√≥ -> ƒë·∫©y local l√™n
      await setDoc(ref, { ...local, updatedAt: serverTimestamp() }, { merge: true });
    } else if (cloud && (!local || cloudTime >= localTime)) {
      // Cloud m·ªõi h∆°n -> k√©o cloud v·ªÅ local + UI
      try { localStorage.setItem('weird-productivity-nobuild-v3', JSON.stringify(cloud)); } catch {}
      if (window.state && cloud.tasks) { window.state = cloud; window.render?.(); }
    } else if (local && localTime > cloudTime) {
      // Local m·ªõi h∆°n -> ƒë·∫©y l√™n cloud
      await setDoc(ref, { ...local, updatedAt: serverTimestamp() }, { merge: true });
    }

    // Nghe realtime ƒë·ªÉ ƒë·ªìng b·ªô ch√©o thi·∫øt b·ªã
    onSnapshot(ref, (s) => {
      const data = s.data();
      if (!data) return;
      try { localStorage.setItem('weird-productivity-nobuild-v3', JSON.stringify(data)); } catch {}
      if (window.state && data.tasks) { window.state = data; window.render?.(); }
    }, (err) => {
      console.error('onSnapshot error', err);
    });
  });
</script>
</body>
</html>
